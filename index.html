<!DOCTYPE html>
<html lang="ja">
<head><meta charset="UTF-8"><title>わかくさ掲示板</title></head>
<body>
  <button onclick="logout()">ログアウト</button>
  <h1>わかくさ掲示板</h1>
  <select id="boardSelect"></select>
  <input type="text" id="name" placeholder="名前">
  <textarea id="content" placeholder="スレッド本文"></textarea>
  <button onclick="createThread()">スレッドを立てる</button>
  <div id="threads"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const supabase = supabase.createClient("https://hfaammdbcoxympbtfwql.supabase.co", "YOUR_PUBLIC_KEY");
    if (!localStorage.getItem("wakakusa_logged_in")) location.href = "login.html";
    function logout() {
      localStorage.removeItem("wakakusa_logged_in");
      localStorage.removeItem("is_admin");
      location.href = "login.html";
    }
    let boards = [];
    let selectedBoardId = null;
    let selectedBoardName = "";

    async function loadBoards() {
      const { data } = await supabase.from("boards").select("*");
      boards = data;
      const select = document.getElementById("boardSelect");
      data.forEach(board => {
        const opt = document.createElement("option");
        opt.value = board.id;
        opt.textContent = board.name;
        select.appendChild(opt);
      });
      if (data.length > 0) {
        selectedBoardId = data[0].id;
        selectedBoardName = data[0].name;
        select.value = selectedBoardId;
        select.onchange = () => {
          selectedBoardId = select.value;
          selectedBoardName = data.find(b => b.id === selectedBoardId).name;
          loadThreads();
        };
        loadThreads();
      }
    }

    async function loadThreads() {
      const { data } = await supabase.from("threads").select("*").eq("board_id", selectedBoardId);
      const div = document.getElementById("threads");
      div.innerHTML = data.map(t => `<div>${t.content}</div>`).join("");
    }

    async function createThread() {
      const name = document.getElementById("name").value || "名無しさん";
      const content = document.getElementById("content").value.trim();
      const isAdmin = localStorage.getItem("is_admin") === "true";
      if (selectedBoardName === "ルール板" && !isAdmin) {
        alert("この板には書き込めません（管理者専用）");
        return;
      }
      if (!content) return alert("本文を入力してください");
      await supabase.from("threads").insert([{ name, content, board_id: selectedBoardId }]);
      loadThreads();
    }

    loadBoards();
  </script>
</body>
</html>